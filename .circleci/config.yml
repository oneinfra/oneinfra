version: 2
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run: |
          curl -L https://nixos.org/nix/install | sh
      - run: |
          source ~/.nix-profile/etc/profile.d/nix.sh
          nix-shell --pure --run "make oi-binaries"
  unit and integration tests:
    machine: true
    steps:
      - checkout
      - run: |
          curl -L https://nixos.org/nix/install | sh
      - run: |
          source ~/.nix-profile/etc/profile.d/nix.sh
          nix-shell --pure --run "make test"
  e2e tests with local CRI endpoints:
    machine: true
    steps:
      - checkout
      - run: |
          curl -L https://nixos.org/nix/install | sh
      - run:
          name: make e2e
          command: |
            source ~/.nix-profile/etc/profile.d/nix.sh
            nix-shell --pure --run "make e2e"
  e2e tests with remote CRI endpoints:
    machine: true
    steps:
      - checkout
      - run: |
          curl -L https://nixos.org/nix/install | sh
      - run:
          name: make e2e-remote
          command: |
            source ~/.nix-profile/etc/profile.d/nix.sh
            nix-shell --pure --run "make e2e-remote"
workflows:
  version: 2
  test:
    jobs:
      - build
      - unit and integration tests
      - e2e tests with local CRI endpoints
      - e2e tests with remote CRI endpoints
